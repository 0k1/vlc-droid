From 73065265f535b1494cbc5b8cdde45b9907339fc2 Mon Sep 17 00:00:00 2001
From: Jean-Baptiste Kempf <jb@videolan.org>
Date: Thu, 7 Jul 2011 01:05:09 +0200
Subject: [PATCH 7/8] Old contribs: compile live on Android

---
 extras/contrib/src/Patches/live-android.patch   |   56 +++++++++++++++++++++++
 extras/contrib/src/Patches/live-uselocale.patch |   32 ++++++-------
 extras/contrib/src/contrib-src.mak              |    3 +
 3 files changed, 74 insertions(+), 17 deletions(-)
 create mode 100644 extras/contrib/src/Patches/live-android.patch

diff --git a/extras/contrib/src/Patches/live-android.patch b/extras/contrib/src/Patches/live-android.patch
new file mode 100644
index 0000000..722bb01
--- /dev/null
+++ b/extras/contrib/src/Patches/live-android.patch
@@ -0,0 +1,56 @@
+diff -ruN live/Makefile.tail live.new/Makefile.tail
+--- live/Makefile.tail	2011-03-15 08:40:37.000000000 +0900
++++ live.new/Makefile.tail	2011-04-13 17:20:54.238795233 +0900
+@@ -14,8 +14,8 @@
+ 	cd $(GROUPSOCK_DIR) ; $(MAKE)
+ 	cd $(USAGE_ENVIRONMENT_DIR) ; $(MAKE)
+ 	cd $(BASIC_USAGE_ENVIRONMENT_DIR) ; $(MAKE)
+-	cd $(TESTPROGS_DIR) ; $(MAKE)
+-	cd $(MEDIA_SERVER_DIR) ; $(MAKE)
++#	cd $(TESTPROGS_DIR) ; $(MAKE)
++#	cd $(MEDIA_SERVER_DIR) ; $(MAKE)
+ 
+ clean:
+ 	cd $(LIVEMEDIA_DIR) ; $(MAKE) clean
+diff -ruN live/config.armlinux live-t/config.armlinux
+--- live/config.armlinux	2011-03-15 08:40:37.000000000 +0900
++++ live.new/config.armlinux	2011-03-22 01:41:26.445293024 +0900
+@@ -1,5 +1,7 @@
++-include ../../../config.mak
++
+-CROSS_COMPILE?=		arm-elf-
+-COMPILE_OPTS =		$(INCLUDES) -I. -O2 -DSOCKLEN_T=socklen_t -DNO_SSTREAM=1 -D_LARGEFILE_SOURCE=1 -D_FILE_OFFSET_BITS=64
++CROSS_COMPILE?=		arm-linux-androideabi-
++COMPILE_OPTS =		$(INCLUDES) -I. -I$(ANDROID_NDK)/platforms/android-9/arch-arm/usr/include -O2 -DLOCALE_NOT_USED -DSOCKLEN_T=socklen_t -DNO_SSTREAM=1 -D_LARGEFILE_SOURCE=1 -D_FILE_OFFSET_BITS=64
+ C =			c
+ C_COMPILER =		$(CROSS_COMPILE)gcc
+ C_FLAGS =		$(COMPILE_OPTS)
+diff -ruN live/groupsock/GroupsockHelper.cpp live.new/groupsock/GroupsockHelper.cpp
+--- live/groupsock/GroupsockHelper.cpp	2011-03-15 08:40:37.000000000 +0900
++++ live.new/groupsock/GroupsockHelper.cpp	2011-03-25 17:52:53.829087921 +0900
+@@ -424,9 +424,9 @@
+   if (!IsMulticastAddress(groupAddress)) return True; // ignore this case
+ 
+   struct ip_mreq_source imr;
+-  imr.imr_multiaddr.s_addr = groupAddress;
+-  imr.imr_sourceaddr.s_addr = sourceFilterAddr;
+-  imr.imr_interface.s_addr = ReceivingInterfaceAddr;
++  imr.imr_multiaddr = groupAddress;
++  imr.imr_sourceaddr = sourceFilterAddr;
++  imr.imr_interface = ReceivingInterfaceAddr;
+   if (setsockopt(socket, IPPROTO_IP, IP_ADD_SOURCE_MEMBERSHIP,
+ 		 (const char*)&imr, sizeof (struct ip_mreq_source)) < 0) {
+     socketErr(env, "setsockopt(IP_ADD_SOURCE_MEMBERSHIP) error: ");
+@@ -442,9 +442,9 @@
+   if (!IsMulticastAddress(groupAddress)) return True; // ignore this case
+ 
+   struct ip_mreq_source imr;
+-  imr.imr_multiaddr.s_addr = groupAddress;
+-  imr.imr_sourceaddr.s_addr = sourceFilterAddr;
+-  imr.imr_interface.s_addr = ReceivingInterfaceAddr;
++  imr.imr_multiaddr = groupAddress;
++  imr.imr_sourceaddr = sourceFilterAddr;
++  imr.imr_interface = ReceivingInterfaceAddr;
+   if (setsockopt(socket, IPPROTO_IP, IP_DROP_SOURCE_MEMBERSHIP,
+ 		 (const char*)&imr, sizeof (struct ip_mreq_source)) < 0) {
+     return False;
diff --git a/extras/contrib/src/Patches/live-uselocale.patch b/extras/contrib/src/Patches/live-uselocale.patch
index 0b56063..af36cfa 100644
--- a/extras/contrib/src/Patches/live-uselocale.patch
+++ b/extras/contrib/src/Patches/live-uselocale.patch
@@ -1,8 +1,6 @@
-Copyright (C) 2008 Rémi Denis-Courmont, adaptation by Felix Kühne (C) 2009.
-Licensed under GNU General Public License version 2 or higher.
-diff -urN live.orig/liveMedia/include/Locale.hh live/liveMedia/include/Locale.hh
---- live.orig/liveMedia/include/Locale.hh	2009-03-23 01:26:16 +0300
-+++ live/liveMedia/include/Locale.hh	2009-03-26 19:17:43 +0300
+diff -ruN live/liveMedia/include/Locale.hh live.new/liveMedia/include/Locale.hh
+--- live/liveMedia/include/Locale.hh	2011-07-06 21:18:43.000000000 +0200
++++ live.new/liveMedia/include/Locale.hh	2011-07-07 01:07:09.881034659 +0200
 @@ -27,23 +27,26 @@
  
  #ifndef LOCALE_NOT_USED
@@ -37,9 +35,9 @@ diff -urN live.orig/liveMedia/include/Locale.hh live/liveMedia/include/Locale.hh
  };
  
  #endif
-diff -urN live.orig/liveMedia/Locale.cpp live/liveMedia/Locale.cpp
---- live.orig/liveMedia/Locale.cpp	2009-03-23 01:26:16 +0300
-+++ live/liveMedia/Locale.cpp	2009-03-26 19:17:43 +0300
+diff -ruN live/liveMedia/Locale.cpp live.new/liveMedia/Locale.cpp
+--- live/liveMedia/Locale.cpp	2011-07-06 21:18:44.000000000 +0200
++++ live.new/liveMedia/Locale.cpp	2011-07-07 01:07:09.881034659 +0200
 @@ -22,19 +22,18 @@
  #include "Locale.hh"
  #include <strDup.hh>
@@ -66,9 +64,10 @@ diff -urN live.orig/liveMedia/Locale.cpp live/liveMedia/Locale.cpp
    }
  #endif
  }
---- live.orig/liveMedia/RTSPClient.cpp	2010-03-16 03:09:46.000000000 +0100
-+++ live/liveMedia/RTSPClient.cpp	2010-08-24 15:04:31.000000000 +0200
-@@ -1019,7 +1019,7 @@
+diff -ruN live/liveMedia/RTSPClient.cpp live.new/liveMedia/RTSPClient.cpp
+--- live/liveMedia/RTSPClient.cpp	2011-07-06 21:18:43.000000000 +0200
++++ live.new/liveMedia/RTSPClient.cpp	2011-07-07 01:07:59.993283156 +0200
+@@ -469,7 +469,7 @@
      // This is the default value; we don't need a "Scale:" header:
      buf[0] = '\0';
    } else {
@@ -77,7 +76,7 @@ diff -urN live.orig/liveMedia/Locale.cpp live/liveMedia/Locale.cpp
      sprintf(buf, "Scale: %f\r\n", scale);
    }
  
-@@ -1033,11 +1033,11 @@
+@@ -483,11 +483,11 @@
      buf[0] = '\0';
    } else if (end < 0) {
      // There's no end time:
@@ -91,9 +90,7 @@ diff -urN live.orig/liveMedia/Locale.cpp live/liveMedia/Locale.cpp
      sprintf(buf, "Range: npt=%.3f-%.3f\r\n", start, end);
    }
  
---- live/liveMedia/RTSPClient.cpp	2010-08-24 17:05:46.000000000 +0200
-+++ live.new/liveMedia/RTSPClient.cpp	2010-08-24 17:04:50.000000000 +0200
-@@ -935,7 +935,7 @@
+@@ -919,7 +919,7 @@
  }
  
  Boolean RTSPClient::parseScaleParam(char const* paramStr, float& scale) {
@@ -102,8 +99,9 @@ diff -urN live.orig/liveMedia/Locale.cpp live/liveMedia/Locale.cpp
    return sscanf(paramStr, "%f", &scale) == 1;
  }
  
---- live/liveMedia/RTSPCommon.cpp.orig	2011-01-06 01:26:50.000000000 +0100
-+++ live/liveMedia/RTSPCommon.cpp	2011-01-09 16:32:24.142645155 +0100
+diff -ruN live/liveMedia/RTSPCommon.cpp live.new/liveMedia/RTSPCommon.cpp
+--- live/liveMedia/RTSPCommon.cpp	2011-07-06 21:18:44.000000000 +0200
++++ live.new/liveMedia/RTSPCommon.cpp	2011-07-07 01:07:59.997283172 +0200
 @@ -137,7 +137,7 @@
  Boolean parseRangeParam(char const* paramStr, double& rangeStart, double& rangeEnd) {
    double start, end;
diff --git a/extras/contrib/src/contrib-src.mak b/extras/contrib/src/contrib-src.mak
index a717c40..99580f0 100644
--- a/extras/contrib/src/contrib-src.mak
+++ b/extras/contrib/src/contrib-src.mak
@@ -1293,6 +1293,9 @@ ifndef HAVE_WINCE
 	patch -p0 < Patches/live-getaddrinfo.patch
 endif
 endif
+ifdef HAVE_ANDROID
+	patch -p0 < Patches/live-android.patch
+endif
 
 LIVE_TARGET-$(ENABLED)        = linux
 LIVE_TARGET-$(HAVE_WIN32)     = mingw
-- 
1.7.5.4

