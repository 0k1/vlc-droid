From 62bd39011a43acc8e05b24cc2c50ca20cf1bcbec Mon Sep 17 00:00:00 2001
From: Jean-Baptiste Kempf <jb@videolan.org>
Date: Sun, 31 Jul 2011 00:05:21 +0200
Subject: [PATCH 7/8] Old contribs: compile live on Android

---
 extras/contrib/src/Patches/live-android.patch |   67 +++++++++++++++++++++++++
 extras/contrib/src/contrib-src.mak            |    3 +
 2 files changed, 70 insertions(+), 0 deletions(-)
 create mode 100644 extras/contrib/src/Patches/live-android.patch

diff --git a/extras/contrib/src/Patches/live-android.patch b/extras/contrib/src/Patches/live-android.patch
new file mode 100644
index 0000000..315610a
--- /dev/null
+++ b/extras/contrib/src/Patches/live-android.patch
@@ -0,0 +1,67 @@
+diff -ruN live/Makefile.tail live.new/Makefile.tail
+--- live/Makefile.tail	2011-03-15 08:40:37.000000000 +0900
++++ live.new/Makefile.tail	2011-04-13 17:20:54.238795233 +0900
+@@ -14,8 +14,8 @@
+ 	cd $(GROUPSOCK_DIR) ; $(MAKE)
+ 	cd $(USAGE_ENVIRONMENT_DIR) ; $(MAKE)
+ 	cd $(BASIC_USAGE_ENVIRONMENT_DIR) ; $(MAKE)
+-	cd $(TESTPROGS_DIR) ; $(MAKE)
+-	cd $(MEDIA_SERVER_DIR) ; $(MAKE)
++#	cd $(TESTPROGS_DIR) ; $(MAKE)
++#	cd $(MEDIA_SERVER_DIR) ; $(MAKE)
+ 
+ clean:
+ 	cd $(LIVEMEDIA_DIR) ; $(MAKE) clean
+diff -ruN live/config.armlinux live-t/config.armlinux
+--- live/config.armlinux	2011-03-15 08:40:37.000000000 +0900
++++ live.new/config.armlinux	2011-03-22 01:41:26.445293024 +0900
+@@ -1,5 +1,7 @@
++-include ../../../config.mak
++
+-CROSS_COMPILE?=		arm-elf-
+-COMPILE_OPTS =		$(INCLUDES) -I. -O2 -DSOCKLEN_T=socklen_t -DNO_SSTREAM=1 -D_LARGEFILE_SOURCE=1 -D_FILE_OFFSET_BITS=64
++CROSS_COMPILE?=		arm-linux-androideabi-
++COMPILE_OPTS =		$(INCLUDES) -I. -I$(ANDROID_NDK)/platforms/android-9/arch-arm/usr/include -O2 -DLOCALE_NOT_USED -DSOCKLEN_T=socklen_t -DNO_SSTREAM=1 -D_LARGEFILE_SOURCE=1 -D_FILE_OFFSET_BITS=64
+ C =			c
+ C_COMPILER =		$(CROSS_COMPILE)gcc
+ C_FLAGS =		$(COMPILE_OPTS)
+diff -ruN live/groupsock/GroupsockHelper.cpp live.new/groupsock/GroupsockHelper.cpp
+--- live/groupsock/GroupsockHelper.cpp	2011-03-15 08:40:37.000000000 +0900
++++ live.new/groupsock/GroupsockHelper.cpp	2011-03-25 17:52:53.829087921 +0900
+@@ -424,9 +424,9 @@
+   if (!IsMulticastAddress(groupAddress)) return True; // ignore this case
+ 
+   struct ip_mreq_source imr;
+-  imr.imr_multiaddr.s_addr = groupAddress;
+-  imr.imr_sourceaddr.s_addr = sourceFilterAddr;
+-  imr.imr_interface.s_addr = ReceivingInterfaceAddr;
++  imr.imr_multiaddr = groupAddress;
++  imr.imr_sourceaddr = sourceFilterAddr;
++  imr.imr_interface = ReceivingInterfaceAddr;
+   if (setsockopt(socket, IPPROTO_IP, IP_ADD_SOURCE_MEMBERSHIP,
+ 		 (const char*)&imr, sizeof (struct ip_mreq_source)) < 0) {
+     socketErr(env, "setsockopt(IP_ADD_SOURCE_MEMBERSHIP) error: ");
+@@ -442,9 +442,9 @@
+   if (!IsMulticastAddress(groupAddress)) return True; // ignore this case
+ 
+   struct ip_mreq_source imr;
+-  imr.imr_multiaddr.s_addr = groupAddress;
+-  imr.imr_sourceaddr.s_addr = sourceFilterAddr;
+-  imr.imr_interface.s_addr = ReceivingInterfaceAddr;
++  imr.imr_multiaddr = groupAddress;
++  imr.imr_sourceaddr = sourceFilterAddr;
++  imr.imr_interface = ReceivingInterfaceAddr;
+   if (setsockopt(socket, IPPROTO_IP, IP_DROP_SOURCE_MEMBERSHIP,
+ 		 (const char*)&imr, sizeof (struct ip_mreq_source)) < 0) {
+     return False;
+--- live/liveMedia/RTSPServerSupportingHTTPStreaming.cpp	2011-07-21 19:59:32.000000000 +0200
++++ live.new/liveMedia/RTSPServerSupportingHTTPStreaming.cpp	2011-07-31 00:02:23.700137585 +0200
+@@ -66,7 +66,7 @@
+     // Failed to 'stat' the file; return an empty string
+     buf[0] = '\0';
+   } else {
+-    strftime(buf, sizeof buf, "Last-Modified: %a, %b %d %Y %H:%M:%S GMT\r\n", gmtime(&sb.st_mtime));
++    strftime(buf, sizeof buf, "Last-Modified: %a, %b %d %Y %H:%M:%S GMT\r\n", gmtime((const time_t*)&sb.st_mtime));
+   }
+ 
+   return buf;
diff --git a/extras/contrib/src/contrib-src.mak b/extras/contrib/src/contrib-src.mak
index a717c40..99580f0 100644
--- a/extras/contrib/src/contrib-src.mak
+++ b/extras/contrib/src/contrib-src.mak
@@ -1293,6 +1293,9 @@ ifndef HAVE_WINCE
 	patch -p0 < Patches/live-getaddrinfo.patch
 endif
 endif
+ifdef HAVE_ANDROID
+	patch -p0 < Patches/live-android.patch
+endif
 
 LIVE_TARGET-$(ENABLED)        = linux
 LIVE_TARGET-$(HAVE_WIN32)     = mingw
-- 
1.7.6

