From c2388d346250407e48ead2f147780eb99016e261 Mon Sep 17 00:00:00 2001
From: Jean-Baptiste Kempf <jb@videolan.org>
Date: Wed, 6 Jul 2011 00:16:58 +0200
Subject: [PATCH 5/6] Revert "Move common predefined macros to config.h and
 common.am"

This reverts commit 7af4b7fed74f000a0145547a301d67314df977d3.
---
 configure.ac         |    6 +-----
 modules/common.am    |    1 -
 src/check_headers    |    1 -
 src/vlc-plugin.pc.in |    1 +
 vlc-config.in.in     |    8 ++++++++
 5 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/configure.ac b/configure.ac
index 096bf97..79063a5 100644
--- a/configure.ac
+++ b/configure.ac
@@ -57,11 +57,7 @@ dnl Check for tools
 dnl
 AC_PROG_CC_C99
 AC_USE_SYSTEM_EXTENSIONS
-AC_DEFINE([_FORTIFY_SOURCE], 2, [Define to 2 to get glibc warnings.])
-AC_DEFINE([_FILE_OFFSET_BITS], 64, [Define to 64 for large files support.])
-AC_DEFINE([_REENTRANT],, [Define to expose reentrant functions.])
-AC_DEFINE([_THREAD_SAFE],, [Same as _REENTANT for some other OSes.])
-AC_DEFINE([__LIBVLC__],, [Define within the LibVLC source code tree.])
+AC_DEFINE([_FORTIFY_SOURCE], 2, [Define to '2' to get glibc warnings.])
 
 AM_PROG_CC_C_O
 AC_PROG_CXX
diff --git a/modules/common.am b/modules/common.am
index fc29eae..1092b62 100644
--- a/modules/common.am
+++ b/modules/common.am
@@ -13,7 +13,6 @@ CLEANFILES = $(BUILT_SOURCES)
 
 LTLIBVLCCORE = $(top_builddir)/src/libvlccore.la
 
-AM_CPPFLAGS = -D__PLUGIN__
 AM_CFLAGS = `$(VLC_CONFIG) --cflags plugin $@`
 AM_CXXFLAGS = `$(VLC_CONFIG) --cxxflags plugin $@`
 AM_OBJCFLAGS = `$(VLC_CONFIG) --objcflags plugin $@`
diff --git a/src/check_headers b/src/check_headers
index 2167f80..0e13920 100755
--- a/src/check_headers
+++ b/src/check_headers
@@ -8,7 +8,6 @@ cd "$(dirname "$0")" || exit $?
 regexp="$(cat ../config.h.in | \
 	sed -n -e 's/^#undef \([A-Z0-9_]*\)$/\1/p' | \
 	grep -v 'WORDS_BIGENDIAN' | \
-	grep -v '__LIBVLC__' | \
 	xargs | \
     sed -e 's/ /\\\(\\s\\\|$\\\)\\\| /g')"
 regexp=" $regexp\$"
diff --git a/src/vlc-plugin.pc.in b/src/vlc-plugin.pc.in
index 61c8880..4afeedc 100644
--- a/src/vlc-plugin.pc.in
+++ b/src/vlc-plugin.pc.in
@@ -15,6 +15,7 @@ Version: @VERSION@
 Cflags: -I${includedir} -I${pkgincludedir}/plugins \
 	-D__PLUGIN__ \
 	-D_FILE_OFFSET_BITS=64 \
+	-D__USE_UNIX98 \
 	@DEFS_BIGENDIAN@ \
 	-D_REENTRANT \
 	-D_THREAD_SAFE
diff --git a/vlc-config.in.in b/vlc-config.in.in
index 502b61f..2b649c8 100644
--- a/vlc-config.in.in
+++ b/vlc-config.in.in
@@ -36,6 +36,7 @@ Options:
         [--objcflags]             output Objective C compilation flags
 Modules:
         vlc                       the main VLC object
+        plugin                    flags for plugin modules
         MODULE                    any available module (dummy, gtk, avi, etc.)
         libs                      flags for external libs
 BLAH
@@ -65,6 +66,11 @@ cppflags="${includes}"
 module=""
 
 #
+#  On Linux and Solaris, activate 64-bit off_t (by default under BSD)
+#
+cppflags="${cppflags} -D_FILE_OFFSET_BITS=64 -D__USE_UNIX98 -D_REENTRANT -D_THREAD_SAFE"
+
+#
 #  Various additional defines
 #
 if [ "${optim}" = speed ]; then
@@ -145,9 +151,11 @@ while test $# -gt 0; do
       usage 1 1>&1
       ;;
     libvlccore)
+      cppflags="${cppflags} -D__LIBVLC__ -I${top_builddir}src/misc"
       ;;
     plugin)
       echo_plugin=yes
+      cppflags="${cppflags} -D__LIBVLC__ -D__PLUGIN__"
       ;;
     *)
       module="$tgt"
-- 
1.7.5.4

