# Sources and objects
JAVA_SOURCES=vlc-android/src/vlc/android/*.java
VLC_APK=vlc-android/bin/VLC-debug.apk
APK_MK=vlc-android/jni/Android.mk
LIBVLCJNI=vlc-android/libs/armeabi/libvlcjni.so
LIBVLCJNI_H=vlc-android/jni/libvlcjni.h

all: vlc.apk

$(APK_MK):
	@echo "=== Creating Android.mk ==="; \
	prefix=""; \
	# Check environment variables
	@if [ -z "$$ANDROID_NDK" -o -z "$$VLC_BUILD_DIR" -o -z "$$VLC_CONTRIB" ]; then \
	    echo "You must define ANDROID_NDK, VLC_BUILD_DIR and VLC_CONTRIB"; \
	    exit 1; \
	 fi; \
	# Append ../ to relative paths
	@if [ `echo $$VLC_BUILD_DIR | head -c 1` != "/" ] ; then \
	    prefix="../"; \
	 fi; \
	 if [ `echo $$VLC_CONTRIB | head -c 1` != "/" ] ; then \
	    VLC_CONTRIB="../$$VLC_CONTRIB"; \
	 fi; \
	 modules=`find $$VLC_BUILD_DIR/modules -name '*.a'`; \
	 LDFLAGS=""; \
	 DEFINITION=""; \
	 BUILTINS="const void *vlc_builtins_modules[] = {\n"; \
	 for file in $$modules; do \
	     name=`echo $$file | sed 's/.*\.libs\/lib//' | sed 's/_plugin\.a//'`; \
	     LDFLAGS="$$LDFLAGS\t$$prefix$$file \\\\\n"; \
	     DEFINITION=$$DEFINITION"vlc_declare_plugin($$name);\n"; \
	     BUILTINS=$$BUILTINS"    vlc_plugin($$name),\n"; \
	 done; \
	 BUILTINS=$$BUILTINS"    NULL\n};\n"; \
	 rm -f $(LIBVLCJNI_H); \
	 echo -e "/* File: libvlcjni.h"                                             > $(LIBVLCJNI_H); \
	 echo -e " * Autogenerated from the list of modules"                       >> $(LIBVLCJNI_H); \
	 echo -e " */\n"                                                           >> $(LIBVLCJNI_H); \
	 echo -e "$$DEFINITION\n"                                                  >> $(LIBVLCJNI_H); \
	 echo -e "$$BUILTINS\n"                                                    >> $(LIBVLCJNI_H); \
	 rm -f $(APK_MK); \
	 echo -e 'LOCAL_PATH := $$(call my-dir)'                                   >> $(APK_MK); \
	 echo -e "include \$$(CLEAR_VARS)\n"                                       >> $(APK_MK); \
	 echo -e "LOCAL_MODULE    := libvlcjni"                                    >> $(APK_MK); \
	 echo -e "LOCAL_SRC_FILES := libvlcjni.c vout.c"                           >> $(APK_MK); \
	 echo -e "LOCAL_C_INCLUDES := \$$(LOCAL_PATH)/../../../../../include"      >> $(APK_MK); \
	 echo -e "LOCAL_LDLIBS := -L$$VLC_CONTRIB/lib \\"                          >> $(APK_MK); \
	 echo -e "\t-L$$ANDROID_NDK/platforms/android-8/arch-arm/usr/lib \\"       >> $(APK_MK); \
	 echo -en "$$LDFLAGS"                                                      >> $(APK_MK); \
	 echo -e "\t$$prefix$$VLC_BUILD_DIR/src/.libs/libvlc.a \\"                 >> $(APK_MK); \
	 echo -e "\t$$prefix$$VLC_BUILD_DIR/src/.libs/libvlccore.a \\"             >> $(APK_MK); \
	 echo -e "\t-ldl -lz -lm -logg -lvorbisenc -lvorbis -lFLAC -lspeex -ltheora -lavformat -lavcodec -lavcore -lavutil -lpostproc -lswscale -lmpeg2 -lgcc -lpng -ldca -ldvbpsi -ltwolame -lkate -llog -la52\n" \
	                                                                           >> $(APK_MK); \
	 echo -e "include \$$(BUILD_SHARED_LIBRARY)\n"                             >> $(APK_MK)

$(LIBVLCJNI): $(APK_MK)
	@echo "=== Building libvlcjni ==="
	@cd vlc-android/; \
	 $(ANDROID_NDK)/ndk-build

vlc-android/local.properties:
	@echo "=== Preparing Ant ==="
	@echo -e "# Auto-generated file. Do not edit.\nsdk.dir=$$ANDROID_SDK"       > vlc-android/local.properties

$(VLC_APK): $(LIBVLCJNI) $(JAVA_SOURCES) vlc-android/local.properties
	@echo "=== Building APK =="
	@if ! which ant >> /dev/null ; then \
	     echo "Error: Ant is not installed. Not compiling APK."; \
	     exit 1; \
	 fi; \
	 cd vlc-android && ant -q debug

libvlcjni: $(LIBVLCJNI)

vlc.apk: libvlcjni $(VLC_APK)

clean:
	rm -rf vlc-android/libs
	rm -rf vlc-android/obj
	rm -rf vlc-android/bin

distclean: clean
	rm -f $(APK_MK)
	rm -f vlc-android/local.properties

install:
	@echo "=== Installing APK on remote device ==="
	@echo "Waiting for device to be ready..." && adb wait-for-device
	@echo "Installing package" && adb install -r $(VLC_APK)

