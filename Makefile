all: compile

vlc-android/jni/Android.mk:
	@echo "=== Creating Android.mk ==="; \
	prefix=""; \
    # check that the variable are defined
	@if [ -z "$$ANDROID_NDK" -o -z "$$VLC_BUILD_DIR" -o -z "$$VLC_CONTRIB" ]; then \
	    echo "You must define ANDROID_NDK, VLC_BUILD_DIR and VLC_CONTRIB"; \
	    exit 1; \
	 fi; \
     # Append ../ if this is not an absolute path
	@if [ `echo $$VLC_BUILD_DIR | head -c 1` != "/" ] ; then \
	    prefix="../"; \
	 fi; \
	 if [ `echo $$VLC_CONTRIB | head -c 1` != "/" ] ; then \
	    VLC_CONTRIB="../$$VLC_CONTRIB"; \
	 fi; \
	 modules=`find $$VLC_BUILD_DIR/modules -name '*.a'`; \
	 LDFLAGS=""; \
	 DEFINITION="" ; \
	 BUILTINS="const void *vlc_builtins_modules[] = {\n" ; \
	 for file in $$modules; do \
	    name=`echo $$file | sed 's/.*\.libs\/lib//' | sed 's/_plugin\.a//'`; \
	    LDFLAGS=$$LDFLAGS"$$prefix$$file "; \
	    DEFINITION=$$DEFINITION"vlc_declare_plugin($$name);\n"; \
	    BUILTINS=$$BUILTINS"    vlc_plugin($$name),\n"; \
	 done; \
	 BUILTINS=$$BUILTINS"    NULL\n};\n"; \
	 rm -f vlc-android/jni/libvlcjni.h; \
	 echo "// libvlcjni.h\n// Autogenerated from the list of modules\n" > vlc-android/jni/libvlcjni.h; \
	 echo "$$DEFINITION\n" >> vlc-android/jni/libvlcjni.h; \
	 echo $$BUILTINS       >> vlc-android/jni/libvlcjni.h; \
	 rm -f vlc-android/jni/Android.mk; \
	 echo 'LOCAL_PATH := $$(call my-dir)' >> vlc-android/jni/Android.mk; \
	 echo "include \$$(CLEAR_VARS)\n" >> vlc-android/jni/Android.mk; \
	 echo "LOCAL_MODULE    := libvlcjni" >> vlc-android/jni/Android.mk; \
         echo "LOCAL_SRC_FILES := libvlcjni.c vout.c" >> vlc-android/jni/Android.mk; \
	 echo "LOCAL_C_INCLUDES := \$$(LOCAL_PATH)/../../../../../include" >> vlc-android/jni/Android.mk; \
         echo "LOCAL_LDLIBS := -L$$ANDROID_NDK/platforms/android-9/arch-arm/usr/lib -L$$VLC_CONTRIB/lib $$LDFLAGS $$prefix$$VLC_BUILD_DIR/src/.libs/libvlc.a $$prefix$$VLC_BUILD_DIR/src/.libs/libvlccore.a -ldl -lz -lm -logg -lvorbisenc -lvorbis -lFLAC -lspeex -ltheora -lavformat -lavcodec -lavcore -lavutil -lpostproc -lswscale -lmpeg2 -lgcc -lpng -logg -ldca -ldvbpsi -ltwolame -lkate -llog -la52" >> vlc-android/jni/Android.mk; \
	 echo "include \$$(BUILD_SHARED_LIBRARY)" >> vlc-android/jni/Android.mk

vlc-android/libs/armeabi/libvlcjni.so: vlc-android/jni/Android.mk
	@echo "=== Building libvlcjni ==="
	@cd vlc-android/; \
	 $(ANDROID_NDK)/ndk-build

compile: vlc-android/libs/armeabi/libvlcjni.so

clean:
	rm -rf vlc-android/libs/*
	rm -rf vlc-android/objs/*

distclean: clean
	rm -rf vlc-android/jni/Android.mk

